# Module 5: Skype for Business and Teams in Office 365 hybrid deployment
# Lab: Implement the Skype for Business hybrid configuration

### Scenario
Adatum is continuing with their strategy to implement a hybrid Office 365 solution. You now need to implement Skype for Business Server in a hybrid configuration with Office 365 and evaluate Teams.

### Objectives
After completing this lab, you will be able to:

- Design and implement a Skype for Business Server hybrid environment.
- Move users to Skype for Business Online or Teams and verify functionality.

> **Note:** The lab steps for this course change frequently due to updates to Office 365, and Microsoft Learning updates the lab steps frequently. Therefore, they are also integrated with your lab environment.

### Lab setup
Estimated time: 120 minutes

Virtual machines: **10984B-LON-DC1**, **10984B-LON-DS1**, **10984B-LON-EX1**, **10984B-LON-SFB**, **10984B-LON-EDGE**, **10984B-LON-CL1**, and **10984B-LON-CL2**

Username: **Adatum\Administrator**

Password: **Pa55w.rd**

Virtual machine: **10984B-LON-WAP1**

Username: **LON-WAP1\Administrator**

Password: **Pa55w.rd**

This lab requires the completion of all prior labs (Lab 1 - Lab 4) before you begin. If the virtual machines are not running, you must complete the following step:

- Sign in to the virtual machines **10984B-LON-DC1**, **10984B-LON-DS1**, **10984B-LON-EX1**, **10984B-LON-WAP1**, **10984B-LON-SFB**, **10984B-LON-EDGE**, **10984B-LON-CL1**, and **10984B-LON-CL2** by using the following credentials.

  - Username: **Administrator**
  - Password: **Pa55w.rd**.

On **10984B-LON-SFB** and **10984B-LON-EDGE**, verify that the Skype for Business Server 2019 ISO image is mounted as drive **D**.

## Exercise 1: Deploy Skype for Business with Enterprise Voice (pre-lab)

### Scenario
To prepare for Module 5, Lab A, Skype for Business Server 2019 will be deployed by using the custom domain provided to you (for example, Adatumyyxxxxx.hostdomain.com). Most of the preparation will be automated. You will need to run a series of scripts and provide information when prompted.

The main tasks for this exercise are as follows:

1. Prepare the environment (these steps have already been done for you)
2. Define topology (these steps have already been done for you)
3. Update the topology
4. Run deployment scripts

    >**Note:** Exercise 1 is a pre-lab configuration. Your instructor may have you complete this exercise prior to the Module 5 lecture. 


#### Task 1: Prepare the environment (these steps have already been done for you)

> **Note:** To save time, the steps in Task 1 and Task 2 have been completed for you. They are provided here for your information and future reference. You can proceed directly to **Task 3: Update Topology** to start this lab.


#### Task 2: Define topology (these steps have already been done for you)

> **Note:** To save time, the steps in Task 1 and Task 2 have been completed for you. They are provided here for your information and future reference. You can proceed directly to **Task 3: Update Topology** to start this lab.


#### Task 3: Update the topology

1. Sign in to **LON-SFB** as **Administrator@adatum.com** with the password **Pa55w.rd**.
2. Open File Explorer.
3. Browse to **C:\Labfiles\Mod05**.
4. Right-click **Lab5.txt**, select **Open with**, and then select **Notepad**.
5. In Notepad, select the **Edit** menu, and then select **Replace**.
6. In the **Replace** window, in the **Find what** box, enter **adatumyyxxxxx.hostdomain.com**. In the **Replace with** box, enter the public domain you were assigned (for example, **AB12345.xtremelabs.us**), and then select **Replace All**.
7. Close the **Replace** window.
8. In the **Lab5.txt - Notepad** window, select the **File** menu, and then select **Save As**.
9. Save the file name as **Lab5.tbxml**, change the **Save as type** to **All files (\*.\*)**, and then select **Save**.

    > **Note:** Be careful not to leave a .txt extension on the filename.

10. When the **Confirm Save As** dialog box appears, select **Yes**.
11. Close Notepad.
12. On the taskbar, select **Skype for Business Server Topology Builder**.
13. In the **Topology Builder** window, select **Open Topology from a local file**, and then select **OK**.
14. Browse to **C:\Labfiles\Mod05**, select **Lab5.tbxml**, and then select **Open**.
15. In the **Skype for Business Server 2019 Topology Builder** window, review the following settings and verify that the domain name provided to you has been accurately applied to the topology builder file:

  - **SIP Domain**
  - **Simple URLs**
  - **Skype for Business \> Adatum \> Skype for Business Server 2019** \> **Standard Edition** \> **Front End Servers** \> **lon-sfb.adatum.com** \> **External web services**
  - **Edge pools** \> **lon-edge.adatum.com** &gt;**External settings**

    > **Note:** The expected result is that your assigned adatumyyxxxxx.hostdomain.com has replaced the placeholder values.

    > Be aware that a Skype for Business Server 2019 Standard Edition server's internal Fully Qualified Domain Names (FQDNs) must match its Active Directory Domain (AD DS) FQDN. This is different from the Enterprise Edition pool FQDN. In this lab, that means that the pool FQDN must be **lon-sfb.adatum.com**. The internal FQDN of **LON-EDGE** is also **lon-edge.adatum.com**.

    > If you see any discrepancies or have any concerns about the settings, please let your instructor know before continuing.

    > If everything looks okay, you are ready to continue to the next step and publish the topology.

16. Right-click **Adatum**, select **Topology**, and then select **Publish**.
17. On the **Publish the topology** page, select **Next**.
18. On the **Select Central Management Server** page, verify that **lon-sfb.adatum.com Adatum** is selected, and then select **Next**.

    > **Note:** The expected results are that all publishing steps have a **Success** status.

19. On the **Publishing wizard complete** page, select **Finish**.
20. Close the **Skype for Business Server 2019, Topology Builder** window.


#### Task 4: Install Skype for Business Server 2019


1. On **LON-SFB**, click the start menu and select **Windows PowerShell**.
2. To install the prerequisites, run the following command:

    ```
    Add-WindowsFeature RSAT-ADDS, Web-Server, Web-Static-Content, Web-Default-Doc, Web-Http-Errors, Web-Asp-Net, Web-Net-Ext, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Http-Logging, Web-Log-Libraries, Web-Request-Monitor, Web-Http-Tracing, Web-Basic-Auth, Web-Windows-Auth, Web-Client-Auth, Web-Filtering, Web-Stat-Compression, Web-Dyn-Compression, NET-WCF-HTTP-Activation45, Web-Asp-Net45, Web-Mgmt-Tools, Web-Scripting-Tools, Web-Mgmt-Compat, Windows-Identity-Foundation, Server-Media-Foundation, Telnet-Client, BITS, ManagementOData, Web-Mgmt-Console, Web-Metabase, Web-Lgcy-Mgmt-Console, Web-Lgcy-Scripting, Web-WMI, Web-Scripting-Tools, Web-Mgmt-Service
    ```

3. To restart **LON-SFB**, type **Restart-Computer** , and then press Enter. After the computer restarts, sign back in as **Adatum\Administrator** by using the password **Pa55w.rd**.
4. On **LON-SFB**, in File Explorer, navigate to **D:\OCS_Eval\Setup\amd64**, and then double-click **Setup.exe**. Wait for the Microsoft Visual C++ 2017 Redistributable (x64) install to complete.
5. On the Skype for Business Server message box, click **Don’t check for updates right now**, and then click **Install**.
6. On the End User License Agreement page, select **I accept the terms in the license agreement**, and then click **OK**.
7. On **LON-SFB**, on the Skype for Business Server 2019 - Deployment Wizard page, click **Install or Update Skype for Business Server System**.
8. On the Skype for Business Server 2019 - Deployment Wizard page, next to **Step 1: Install Local Configuration Store**, click **Run**.
9. On the Configure Local Replica of Central Management Store page, verify that **Retrieve directly from the Central Management Store** is selected, and then click **Next**. 
    
    > **Note:**This step will take about 10 minutes to execute.
10. On the Executing Commands page, when the Task Status shows **Completed**, click **Finish**.
11. On **LON-SFB**, on the Skype for Business Server 2019 - Deployment Wizard page, next to **Step 2: Setup or Remove Skype for Business Server Components**, click **Run**.
12. On the Setup Skype for Business Server Components page, click **Next**.
    
    > **Note:This step will take approximately 15 minutes to run.**
13. On the Executing Commands page, click **Finish**.
14. On **LON-SFB**, on the Skype for Business Server 2019 - Deployment Wizard page, next to **Step 3: Request, Install or Assign Certificates**, click **Run**.
15. In the Certificate Wizard window, select **Default Certificate**, and then click **Request**.
16. On the Certificate Request page, select the following options and then click **Next**:
  - In the **Select a CA from the list detected in your environment** drop-down list, verify that **LON-DC1.Adatum.com\AdatumCA** is present.
  - In the **Friendly Name** box, type **LON-SFB Skype for Business Server 2019 Default Certificate**.
  - In the **Organization** box, type **Adatum**.
  - In the **Organizational Unit** box, type **IT**.
  - In the **Country/Region** drop-down list, select **United Kingdom**.
  - In the **State/Province** box, type **England**.
  - In the **City/Locality** box, type **London**.
  - In the **Select one or more SIP Domains … to be added to the subject alternative names list**, select **All**.
17.	On the Certificate Request Summary page, click **Next**.
18.	On the Executing Commands page, when the Task Status shows **Completed**, click **Next**.

    > **Note: If the certificate request fails, check if the Active Directory Certificate Services service is running on LON-DC1. If not, start the service, and then retry the certificate request.**

19.	On the Online Certificate Request Status page, verify that **Assign this certificate to Skype for Business Server certificate usages** is selected, and then click **Finish**.
20.	On the Certificate Assignment page, click **Next**.
21.	On the Certificate Assignment Summary page, click **Next**.
22.	On the Executing Commands page, when the Task Status shows **Completed**, click **Finish**.
23.	On the Certificate Wizard, click the down arrow next to **Default Certificate** to expand the Certificate Type.
24.	Verify that **Server Default**, **Web Services Internal**, and **Web Services External** have green checkmarks next to them.
25.	In the Certificate Wizard window, select **OAuthTokenIssuer**, and then click **Request**.
26.	On the Certificate Request page, leave the default settings and  click **Next**.
27.	On the Certificate Request Summary page click **Next**.
28.	On the Executing Commands page verify the Task status is **Completed** and then click **Next**.
29.	On the Online Certificate Request Status page verify that **Assign this certificate to Skype for Business Server certificate usages** is selected and click **Finish**.
30.	On the Certificate Assignment page click **Next**.
31.	On the Certificate Assignment Summary page click **Next**.
32.	ON the Executing Commands page verify the Task status is **Completed** and click **Finish**.
33.	On the Certificate Wizard, click the down arrow next to **OAuthTokenIssuer** to expand the Certificate Type.
34.	Verify that the **OAuthTokenIssuer** has a green check mark next to it.
35.	Click **Close** to close the Certificate Wizard.
36.	On the Skype for Business Server 2019 – Deployment Wizard page, click **Exit**.


#### Task 5: Update Skype for Business Server 2019


1. On **LON-SFB**, click start menu and expand Skype for Business Server 2019 and then select **Skype for Business Server Management Shell**.
2. In the Skype for Business Management Shell run **Stop-CsWindowsService**.
3. Type CD **C:\Labfiles** and press **Enter**. 
4. In the Skype for Business Management shell run **.\SkypeServerUpdateInstaller.exe**
5. In the Skype for Business Server 2019 Update Installer window review the Installed Version vs. the Update Version for each component and then click **Install Updates**.
6. Click **No** when asked **“You must reboot this computer to complete the update process. Would you like to reboot now?”** to postpone the restart of the computer.
7. Click **Close** on the Skype for Business Server 2019 Update Installer window.

    >**Note it may be behind the Skype for Business Server Management Shell window.**

8. In Skype for Business Management Shell type **CD “C:\Program Files\Skype for Business Server 2019\Deployment”** and press **Enter**.
9. Type the following command and press Enter:

    ```
    .\Bootstrapper.exe
    ```
10. Restart the computer by typing **Restart-Computer** in the Skype for Business Management Shell and then press **Enter**.
11. When the server restarts sign back in as **Adatum\Administrator** with the password **Pa55w.rd**. Open the Skype for Business Server Management Shell.

    >**Note: Wait for the all the Skype for Business Server services to start. This could take several minutes. You can run the Get-CsWindowsService cmdlet to check the state of the services.**

12.	In the Skype for Business Management Shell type the following command to update the Skype for Business Server 2019 Standard Edition local databases and then press Enter:

    ```
    Install-CsDatabase -Update -LocalDatabases
    ```
    >**Note: Wait for the update to complete. You can safely disregard the warnings for Install-CsDatabase**

#### Task 6: Install Skype for Business Server 2019 Edge Server

1. On **LON-SFB**, in the Skype for Business Management Shell run the following commands to export the configuration and place a copy on LON-EDGE.  
    ```
    Export-CsConfiguration -FileName C:\Labfiles\Mod05\EdgeConfig.zip
    ```

    ```
    Robocopy.exe C:\Labfiles\Mod05 \\lon-edge\C$\Labfiles\Mod05\ EdgeConfig.zip
    ```
2. On **LON-EDGE**, click the start menu and select **Windows PowerShell**.
3. To install the prerequisites, run the following command:

    ```
    Add-WindowsFeature RSAT-ADDS, Web-Server, Web-Static-Content, Web-Default-Doc, Web-Http-Errors, Web-Asp-Net, Web-Net-Ext, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Http-Logging, Web-Log-Libraries, Web-Request-Monitor, Web-Http-Tracing, Web-Basic-Auth, Web-Windows-Auth, Web-Client-Auth, Web-Filtering, Web-Stat-Compression, Web-Dyn-Compression, NET-WCF-HTTP-Activation45, Web-Asp-Net45, Web-Mgmt-Tools, Web-Scripting-Tools, Web-Mgmt-Compat, Windows-Identity-Foundation, Server-Media-Foundation, Telnet-Client, BITS, ManagementOData, Web-Mgmt-Console, Web-Metabase, Web-Lgcy-Mgmt-Console, Web-Lgcy-Scripting, Web-WMI, Web-Scripting-Tools, Web-Mgmt-Service
    ```

4. To restart **LON-EDGE**, type **Restart-Computer** , and then press Enter. After the computer restarts, sign back in as **Administrator** by using the password **Pa55w.rd**.
5. On **LON-EDGE**, in File Explorer, navigate to **D:\OCS_Eval\Setup\amd64**, and then double-click **Setup.exe**. Wait for the Microsoft Visual C++ 2017 Redistributable (x64) install to complete.
6. On the Skype for Business Server message box, click **Don’t check for updates right now**, and then click **Install**.
7. On the End User License Agreement page, select **I accept the terms in the license agreement**, and then click **OK**.
8. On **LON-EDGE**, on the Skype for Business Server 2019 - Deployment Wizard page, click **Install or Update Skype for Business Server System**.
9. On the Skype for Business Server 2019 - Deployment Wizard page, next to **Step 1: Install Local Configuration Store**, click **Run**.
10. On the Configure Local Replica of Central Management Store page, verify that **Import from a file (recommended for Edge Servers)** is selected, and then click **Browse**. 
11. On the Open dialog box navigate to **C:\Labfiles\Mod05**, select **EdgeConfig.zip**, and then click **Open**. 
12. On the Configure Local Replica of Central Management Store page, click **Next**.
    
    > **Note:**This step will take about 10 minutes to execute.
13. On the Executing Commands page, when the Task Status shows **Completed**, click **Finish**.
14. On **LON-EDGE**, on the Skype for Business Server 2019 - Deployment Wizard page, next to **Step 2: Setup or Remove Skype for Business Server Components**, click **Run**.
15. On the Setup Skype for Business Server Components page, click **Next**.
    
    > **Note:This step will take approximately 15 minutes to run.**
16. On the Executing Commands page, click **Finish**.
17. On the Skype for Business Server 2019 - Deployment Wizard page, click **Exit**.
    
    >**Note:** You will now obtain and assign certificates using Windows PowerShell.
18. To open Windows PowerShell, if it is not already open, click the start menu and select **Windows PowerShell**.
19. To request an internal certificate, in Windows PowerShell, type the following command and then press Enter:

    ```
    $Certificate = Request-CSCertificate -New -Type Internal -CA "LON-DC1.adatum.com\AdatumCA" -Country "GB" -State "England" -City "London" -FriendlyName "Edge Internal" -KeySize 2048 -PrivateKeyExportable $True -Organization "Adatum" -OU "IT" -CAAccount "adatum\administrator" -CAPassword "Pa55w.rd" -AllSipDomain -Verbose
    ```

20. To assign the internal certificate, in Windows PowerShell, type the following command and then press Enter:

    ```
    Set-CsCertificate -Thumbprint $Certificate.Thumbprint -Type Internal
    ```
21. To request an external certificate, in Windows PowerShell, type the following command and then press Enter:

    ```
    $Certificate2 = Request-CSCertificate -New -Type AccessEdgeExternal,DataEdgeExternal,AudioVideoAuthentication -CA "LON-DC1.adatum.com\AdatumCA" -Country "GB" -State "England" -City "London" -FriendlyName "Edge External" -KeySize 2048 -PrivateKeyExportable $True -Organization "Adatum" -OU "IT" -CAAccount "adatum\administrator" -CAPassword "Pa55w.rd" -AllSipDomain -Verbose 
    ```

    >**Note:**  The **-Verbose** parameter will display the steps performed by the script in yellow. These are not warnings or errors and can safely be ignored.

22. To assign an external certificate, in Windows PowerShell, type the following command and then press Enter:

    ```
    Set-CsCertificate -Thumbprint $Certificate2.Thumbprint -Type AccessEdgeExternal,DataEdgeExternal,AudioVideoAuthentication
    ```

23. Close the PowerShell window.


#### Task 7: Update Skype for Business Edge Server


1. On **LON-EDGE**, click start menu and expand Skype for Business Server 2019 and then select **Skype for Business Server Management Shell**.
2. In the Skype for Business Management Shell run **Stop-CsWindowsService**.
3. Type CD **C:\Labfiles** and press **Enter**. 
4. In the Skype for Business Management shell run **.\SkypeServerUpdateInstaller.exe**
5. In the Skype for Business Server 2019 Update Installer window review the Installed Version vs. the Update Version for each component and then click **Install Updates**.
6. Click **No** when asked **“You must reboot this computer to complete the update process. Would you like to reboot now?”** to postpone the restart of the computer.
7. Click **Close** on the Skype for Business Server 2019 Update Installer window.

    >**Note it may be behind the Skype for Business Server Management Shell window.**

8. In Skype for Business Management Shell type **CD “C:\Program Files\Skype for Business Server 2019\Deployment”** and press **Enter**.
9. Type the following command and press Enter:

    ```
    .\Bootstrapper.exe
    ```
10. Restart the computer by typing **Restart-Computer** in the Skype for Business Management Shell and then press **Enter**.
11. When the server restarts sign back in as **Administrator** with the password **Pa55w.rd**. Open the Skype for Business Server Management Shell.

    >**Note: Wait for the all the Skype for Business Server services to start. This could take several minutes. You can run the Get-CsWindowsService cmdlet to check the state of the services.**


## Exercise 2: Design and implement a Skype for Business hybrid configuration

### Scenario
Adatum currently has the following Exchange Server servers deployed:

Atlanta site (6,000 users):

- **atl-pool.adatum.com**
- **ATL-FE1** (Skype for Business Front End - Enterprise Edition)
- **ATL-FE2** (Skype for Business Front End - Enterprise Edition)
- **ATL-FE3** (Skype for Business Front End - Enterprise Edition)
- **ATL-BE1** (SQL Server 2016)

London site (1,500 users):

- **LON-SE1** (Standard Edition Server)
- **LON-SE2** (Standard Edition Server)

**Additionally, the following information is available:**

- The London site and Atlanta site are both connected to the internet.
- Network load balancers are used to distribute connections to the three servers in the atl-pool.adatum.com Front End pool.
- **Lyncdiscoverinternal** resolves to atl-pool.adatum.com.
- You have an Office 365 Enterprise E3 trial subscription for 25 pilot users.
- Your manager asks you to evaluate Microsoft Teams.
- Mailbox migration is 50 percent complete. Approximately half of the users from each site still have mailboxes on-premises.
- Azure AD Connect was deployed to support the Exchange hybrid configuration.
- Enterprise Voice has been deployed, but only the users in London are enabled for it. 
- The London IP-PBX is already integrated with Enterprise Voice and users can make and receive phone calls by using their Skype for Business clients.
- Users in Atlanta use a legacy TDM-PBX and proprietary phones for PSTN connectivity. Atlanta users cannot use their Skype for Business clients to make calls to the PSTN.

**You have the following requirements:**

- Atlanta users must be able to make phone calls to any outside phone number by using their Skype for Business client.
- Users in the Research department in Atlanta must be able to communicate with a line of business applications that use XMPP for instant messaging and presence.
- The pilot users for Teams must be able to place calls through their on-premises IP-PBX.
- The world-wide sales organization for Adatum wants to leverage call queues. All sales representatives must be agents in at least one call queue.
- If the Atlanta site goes down, Atlanta users must be able to continue to communicate by using their Skype for Business clients.

The main tasks for this exercise are as follows:

1. Read and analyze the scenario requirements
2. Design and discuss a solution with the class
3. Configure Enterprise Voice
4. Deploy a Skype for Business Server hybrid configuration


#### Task 1: Read and analyze the scenario requirements

1. Read the exercise scenario and analyze the requirements from an integration perspective.
2. Identify the configurations that are necessary to satisfy the requirements.
3. Sign in to **LON-CL1** as **Adatum\Beth** with the password **Pa55w.rd**.
4. Open File Explorer, browse to **C:\Labfiles\Mod05**, and then open **10984_Lab5_Design.pptx**.
5. Use the PowerPoint slides to help you document your design.


#### Task 2: Design and discuss a solution with the class
Use the questions below to help refine your solution.

- **Question 1**: What components do you need to install and configure to satisfy the requirements?
- **Question 2**: What are the licensing requirements for Teams?
- **Question 3**: When moving users to Teams, what precautions should Adatum take based on their existing environment?
- **Question 4**: Which voice solution will work best for Adatum?



#### Task 3: Configure On-premises users

1. Sign in to **LON-SFB** as **Adatum\Administrator** with the password **Pa55w.rd**.
2. Open Skype for Business Server Control Panel and sign in as **Adatum\Administrator** with the password **Pa55w.rd**.
3. In the left navigation pane, select **Users**.
4. On the **USER SEARCH** page, select **Enable users**, and under **New Skype for Business Server User**, select **Add**.
5. In the **Search** box, enter **Holly**, and then select **Find**.
6. Select **Holly Spencer**, and then select **OK**.
7. In the **Assign users to a pool** drop-down box, select **lon-sfb.adatum.com**.
8. Under **Generate user's SIP URI**, select **Use the user principal name (UPN)**.
9. In the **Telephony** drop-down box, select **Enterprise Voice**.
10. In the **Line URI** box, enter **tel:+442079312380**.
11. On the **USER SEARCH** page, select **Enable**.
12. Repeat steps 4-11 to enable the following users for Skype for Business with Enterprise Voice by using the Line URI provided for each user.

    |  **User** | **Line URI** |
    | ------------- | ------------------- |
    | Adam Hobbs | tel:+442079312341 |
    | Beth Burke | tel:+442079312335 |
    | Abbi Skinner | tel:+442079312310 |
    | Allan Yoo | tel:+442079312320 |
    | Cai Chu | tel:+442079312383 |
    | Ella Perry | tel:+442079312372 |
    | Jon Friday | tel:+442079312308 |

13. In the left navigation pane, select **Federation and External Access**, and then select the **EXTERNAL ACCESS POLICY** tab.
14. On the **EXTERNAL ACCESS POLICY** tab, review the settings for the **Global** policy. Note that there are no external access options enabled at this time.
15. Select the **ACCESS EDGE CONFIGURATION** tab and review the settings for the **Global** policy. Note that no external access options are enabled.
16. Select **SIP FEDERATED DOMAINS**, and then verify that there are no **Allowed or Blocked** domains configured.
17. Sign in to **LON-DS1** as **Adatum\Administrator** with the password **Pa55w.rd**.
18. Open Windows PowerShell.
19. In the **Windows PowerShell** window, enter the following cmdlet, and then press Enter:

    ```
    Start-ADSyncSyncCycle -PolicyType Initial
    ```


#### Task 4: Deploy a Skype for Business hybrid configuration

1. On **LON-SFB**, open File Explorer, browse to **C:\LabFiles\Mod05**, and then double-click **msoidcli_64bit.msi**.
2. Install the Microsoft Online Services Sign-in Assistant by using the default settings, and then select **Finish**.
3. On the taskbar, select **Skype for Business Server Management Shell**.
4. At the **Skype for Business Server Management Shell** command prompt, enter the following command, and then press Enter:

    ```
    Install-Module MSOnline
    ```

5. In the **NuGet provider is required to continue** box, type **Y**, and then press Enter.
6. In the **Untrusted Repository** box, type **Y**, and then press Enter.
7. At the **Skype for Business Server Management Shell** command prompt, enter the following command, and then press Enter:

    ```
    Set-CSAccessEdgeConfiguration -AllowOutsideUsers 1 -AllowFederatedUsers 1 -EnablePartnerDiscovery 1 -UseDnsSrvRouting -AllowAnonymousUsers 1
    ```

8. Enter the following command, and then press Enter:

    ```
    Set-CsExternalAccessPolicy -EnableFederationAccess 1 -EnablePublicCloudAccess 1 -EnableOutsideAccess 1
    ```

9. Enter the following command, and then press Enter:

    ```
    Get-CsHostingProvider | Remove-CsHostingProvider
    ```

    > **Note:** This will remove any existing hosting provider to create a clean environment for the lab.

10. Enter the following command, and then press Enter:

    ```
    New-CSHostingProvider -Identity Office365 -ProxyFqdn sipfed.online.lync.com -Enabled $true -EnabledSharedAddressSpace $true -HostsOCSUsers $true -VerificationLevel UseSourceVerification -IsLocal $false -AutodiscoverUrl https://webdir.online.lync.com/Autodiscover/AutodiscoverService.svc/root
    ```

11. Enter the following command, and then press Enter:

    ```
    $creds=Get-Credential
    ```

12. When prompted, enter your Office 365 lab tenant administrator account username and password. For example, Beth@adatumyyxxxxx.onmicrosoft.com.
13. Enter the following command, and then press Enter:

    ```
    Import-Module SkypeOnlineConnector
    ```

    > **Note:** You can safely ignore the warnings about WSMan NetworkDelayms.

14. Enter the following command, and then press Enter:

    ```
    $CSSession = New-CsOnlineSession -Credential $creds
    ```

15. Enter the following command, and then press Enter:

    ```
    Import-PSSession $CSSession -AllowClobber
    ```

16. Enter the following command, and then press Enter:

    ```
    Set-CsTenantFederationConfiguration -SharedSipAddressSpace $True
    ```

17. Close the **Skype for Business Server Management Shell** command prompt.

    > **Note:** You should have now configured the environment in preparation for moving on-premises Skype for Business users to Skype for Business Online.

18. Open the **Skype for Business Server 2019 Control Panel**. If not currently signed in, sign in as **Adatum\Administrator** with the password **Pa55w.rd**.
19. In the left navigation pane, select **Home**.
20. Under **Connection to Office 365**, select **Sign in to Office 365**.
21. Sign in to **Office 365** by using the Office 365 tenant administrator's credentials. For example, Beth@adatumyyxxxxx.onmicrosoft.com. Use the password you created in Lab 1.
22. After the message **you have successfully signed in to Office 365** appears, select **Close**.
23. Under **Connection to Office 365**, select **Set up hybrid with Teams and Skype for Business Online**.

    > **Note:** We are running the **Set up hybrid with Teams and Skype for Business Online Wizard** to confirm that all the PowerShell cmdlets worked correctly.

24. On the **Set up Hybrid with Teams and Skype for Business Online** page, select **Next**.
25. Review the information on the **Set up Hybrid with Teams and Skype for Business Online** page and then click **Next**.
26. If any red **X**s appear, then something expected is missing in the hybrid configuration.
26. Select **Next** to allow the wizard to configure the missing setting (or settings).
27. Confirm that green check marks appear next to all four hybrid configuration settings and select **Close**.

    > **Note:** Leave the Skype for Business Server 2019 Control Panel open. You will need it in the next exercise.

    > **Result**: After completing this exercise, you will have successfully:

    >- Read and analyzed the scenario requirements.
    >- Designed a solution.
    >- Set up Hybrid with Office 365


## Exercise 3: Move users to Skype for Business Online and Teams

### Scenario
  Before moving users to Skype for Business online, you need to deploy a hybrid configuration.


The main tasks for this exercise are as follows:

1. Move users to Skype for Business Online
2. Configure Microsoft Teams for your Office 365 tenant
3. Verify communications between users on Skype for Business Server and users on Skype for business Online
4. Verify communications between users on Skype for Business and Teams
5. Verify communications between Teams only


#### Task 1: Move users to Skype for Business Online

1. Sign in to **LON-CL1** as **Adatum\Adam** with the password **Pa55w.rd**.
2.  select **Start**, enter **Skype**, and then select **Skype for Business**.
3. If the **The fine print** window appears, select **Accept and start Skype for Business**.
4. If the Microsoft Office Activation Wizard window appears, Click **Close**.
5. Confirm that **Adam Hobbs** is signed in.
6. In the **Find** box, enter **abbi@adatumyyxxxxx.hostdomain.com**, and then confirm that **Abbi Skinner** resolves on the **MY CONTACTS** tab.
7. Right-click **Abbi Skinner**, and then select **Add to Favorites**.
8. Sign in to **LON-CL2** as **Adatum\Abbi** with the password **Moc10984B**.
9.  select **Start**, enter **Skype**, and then select **Skype for Business**.
10. In the **The fine print** window, select **Accept and start Skype for Business**.
11. Confirm that **Abbi Skinner** is signed in.
12. In the **Find** box, enter **adam@adatumyyxxxxx.hostdomain.com**, and then confirm that **Adam Hobbs** resolves on the **MY CONTACTS** tab.
13. Right-click **Adam Hobbs**, and then select **Add to Favorites**.
14. On **LON-SFB**, open Internet Explorer.
15. In the address bar, enter **https://portal.office.com/adminportal/home**, and then press Enter.
16. Sign in as **Beth@adataumyyxxxxx.onmicrosoft.com** with the password you created in Module 1.

    > **Note:** Steps 17-21 should have been completed as part of the Module 04 Lab. After you confirm that Adam, Abbi, Allan, Cai, Ella, and Jon have been assigned Office 365 Enterprise E5 licenses, you can skip to step 22.

17. Click **Admin**, and then select **Users**. Select **Active Users**, and then select the check boxes for the following user accounts:

  - **Adam Hobbs**
  - **Abbi Skinner**
  - **Allan Yoo**
  - **Cai Chu**
  - **Ella Perry**
  - **Jon Friday**

18. Scroll back to the top of the page, confirm 6 users are selected, select the ellipse icon (**...**), and then select **Manage Product licenses**. 
19. Under **Under Manage product licenses**, in the right pane, select **Add to existing product license assignments**, and then select **Next**.
20. Under **location**, select **United States**, assign the **Office 365 Enterprise E5** licenses by changing the switch from **Off** to **On**, and then select **Add**.
21. Confirm that six licenses were assigned, and then select **Close**.
22. Restore the **Skype for Business Server 2019 Control Panel** window.
23. In the left navigation pane, select **Home**. Under **Connection to Office 365**, verify that you are still signed in to Office 365 with tenant credentials.
24. In the **Skype for Business Control Panel** window, in the left navigation pane, select **Users**. On the **USER SEARCH** tab, select **Find**.
25. Verify that a list of all Skype for Business-enabled users displays.
26. Select **Adam Hobbs**, select **Action**, and then select **Move selected users to Skype for Business Online**.
27. In the **Move users to Skype for Business Online** Wizard, select **Next**.
28. If your credentials have expired, you will get a message that says **You're not signed into Office 365**. If this occurs, select **Sign in to Office 365**, and then sign in with your Microsoft Office 365 tenant credentials. For example, Beth@adatumyyxxxxx.onmicrosoft.com.
29. Use the password you created in Lab 1.
30. After you sign in, select **OK**, and then select **Close**.
31. In the **Move users to Skype for Business Online** Wizard, select **Next**.
32. When a message, "Do you want to move the selected users," appears, select **Next**.

    > **Note:** While the move is successful, the Skype for Business Server 2019 Edge (**LON-EDGE**) does not have a public IP in this lab environment. This will prevent full hybrid communications for this lab.

    > **Note:** If the move failed with the error "**Cannot find user in Active Directory with the follwing SIP URI**", run **Start-ADSyncSyncCycle -PolicyType Initial** on **LON-DS1** and try again after sync completes. It can take 30 minutes or longer for an **On-premises (hybrid)** user, like Adam Hobbs, to appear in the **Microsoft Teams Admin Center** after assigning the Office 365 Enterprise E5 license. Until provisioning completes, this error will persist.

33. Close the **Move users to Skype for Business Online** Wizard.


#### Task 2: Configure Microsoft Teams for your Office 365 tenant

1. If not currently signed in, sign in to **LON-SFB** as **Adatum\Administrator** with the password **Pa55w.rd**.
2. Restore or open the Internet Explorer window.
3. In the address bar, enter **https://admin.teams.microsoft.com/dashboard**, and then press **enter**.
4. If prompted, sign in as **Beth@Adatumyyxxxxx.onmicrosoft.com** with the password you created in Module 1.

    >**Note:** If Stay signed in? page appears click **No**.

5. In the left navigation pane, expand **Org-wide settings**, and then select **Teams upgrade**.
6. Confirm your trial tenant status. It should say **Congratulation! Your organization is already in Teams**.

     > **Note:** If your production organization, at work, still has Skype for Business Online licenses you may see upgrade options. You can choose an upgrade option for your organization on the **Teams upgrade** page, under **Coexistence mode**, by selecting the drop-down arrow. A change at this level will impact all users in the organization by default.

7. In the left navigation pane, select **Users**, and then review the list of users that are already licensed for Teams.
8. Select the **Directory status** tab to sort the table by status, and note the user accounts that have the status of **Online**.

    > **Note:** Only Teams users that have the directory status of **Online (hybrid)** have full coexistence between their Skype for Business and Teams clients.

9. Under **Org-wide settings**, review the default settings for the **External access** and **Guest Access** tabs.
10. In the Guest access window change the **Allow guest access in Teams** slider to **On**, verify that all associated settings are also set to **On**, and then click **Save**.

    >**Note:** It can take up to 24 hours for the change to take effect.

11. Keep the **Microsoft Teams admin center** window open, as you will use it later in this lab.


#### Task 3: Verify communications between users on Skype for Business Server and users on Skype for Business Online

1. On **LON-CL1**, when prompted to sign in, sign in as **Adam@Adatumyyxxxxx.hostdomain.com** with the password **Pa55w.rd**.
2. On the **Use this account everywhere on your device** window verify that **Allow my organization to manage my device** is selected and then click **Yes**. 
3. On the **You're all set** page click **Done**. 
4. Verify whether **Adam** is able to sign in automatically to Skype for Business  after his account was moved.

    >**Note:** Even though the account was moved to Skype for Business Online, the organization is already a Teams only organization. Therefore all users moved to Office 365 will require a Teams client in this tenant. 

5. On the **Your organization is now using Microsoft Teams!** window, select **Go to Teams**, verify that **Adam** is automatically signed in to the Teams web client. 
6. On **LON-CL2**, verify you are still signed in as **Abbi@Adatumyyxxxxx.hostdomain.com** with the password **Moc10984B**.
7. Verify that **Abbi** is also still signed in to Skype for Business.
8. In the **Favorites** section, double-click **Adam Hobbs**.
9. In the IM window for Adam Hobbs, enter **Hello Adam**, and then select **Send**. Note the error that is returned.
10. On **LON-CL1**, restore the Teams web client.
11. Select Chat in the left navigation, select the Contacts tab, in the **Favorites** section, select **Abbi Skinner**.
12. In the **Type a new message** box for **Abbi Skinner**, enter **Hello Abbi**, and then select **Send**. Note the error that is returned.

    > **Note:** The IM communications between Adam and Abbi are not expected to work.

    > The **LON-EDGE** server does not have a public IP on the external interface in this lab environment. While there is internet access, it is from the internal network and the Web Application Proxy. This only provides limited functionality.

13. Close the Teams web client window.


#### Task 4: Verify communications between users on Skype for Business and Teams

1. On **LON-CL2**, open Microsoft Edge.
2. In the address bar, enter **https://teams.microsoft.com**, and then press Enter.
3. Sign in as **Abbi@Adatumyyxxxxx.hostdomain.com** with the password **Moc10984B**. If prompted to stay signed in, select **Yes**. If prompted to save your password, select **No**.
4. Select **Use the web app instead**. Close the **Bring your team together** page.
5. In the left pane, select **Chat**.
6. On the top of the **Teams** window, to the left of the **Search** box, select the **New Chat** icon.
7. In the **Search** box, enter **Adam**, and then, from the search results, select **Adam Hobbs**.
8. On the **Conversation** tab, in the **Type a new message** box, enter **Hello Adam!** and press Enter.
9. On **LON-CL1**, Open Microsoft Edge.
11. In the address bar, enter **https://teams.microsoft.com/downloads**, and then press Enter.
12. Under the **Desktop** , select **Windows 64-bit**.
13. When prompted, select **Save As**, browse to **C:\Labfiles\Mod05**, and then select **Save**.
14. After the download completes, select **Run**, close Edge and wait for installation to complete.

    > **Note:** If the download times out, try to download it again. It might take a few attempts, but it should eventually download.

    > If a message displays that says This App can't be run on your PC, this can be addressed by either of the following two methods:

    >  1. Open Microsoft Edge in **InPrivate** mode, and then download and run the application.

    >  2. In Microsoft Edge, under **Settings\View Advanced Settings**, turn off **Help protect me from malicious sites and downloads with Windows Defender SmartScreen**.

15. If prompted, in the **Login to Microsoft Teams** window, confirm that Adam@Adatumyyxxxxx.hostdomain.com is the specified username. enter **Pa55w.rd** as the password, and then select **Sign in**. 
16. If an additional window appears close it.

    > **Note:** The Teams desktop app is not included with an Office Pro Plus installation. However, you can download it from [https://teams.microsoft.com/downloads](https://teams.microsoft.com/downloads) for Windows, Mac, iOS, and Android.

17. In the left pane, note that **Chat** has a red **1**. Select **Chat**.
18. Under **Recent**, select **Abbi Skinner**.
19. In the **Type a new message** box, enter **Hello Abbi!**
20. Select the **Sticker** icon, and then select the **SuccessKid** sticker. Enter a **Top caption** and **Bottom caption**, and then select **Done**.
21. Select **Send**.
22. On **LON-CL2**, verify that **Abbi** received the chat.

> **Result**: After completing this exercise, you will have successfully:

- Configured Skype for Business Server 2019.
- Configured Teams.
- Tested Skype for Business and Teams communications.
- Tested Teams only communications.




## Exercise 4: Enable Office 365 Phone System and Audio Conferencing (Optional exercise)

### Scenario
You need to review the **audio conferencing** settings and add a new service number for audio conferencing.

The main tasks for this exercise are as follows:

1. Configure Audio Conferencing
2. Prepare for the next module


#### Task 1: Configure Audio Conferencing

1. On **LON-SFB**, verify that the **Microsoft Teams admin center** window is still open. If not, in the address bar, enter **https://admin.teams.microsoft.com/dashboard**.
2. Sign in as **Beth@Adatumyyxxxxx.onmicrosoft.com**.
3. In the **Microsoft Teams admin center**, in the feature pane, expand **Meetings**, and then select **Conference bridges**.
4. In the results pane, review the Microsoft conference bridge phone numbers available for your tenant. Locate and select the phone number listed as the **+1 ### ### ####(default)** number.
5. In the left navigation pane, select **Voice** and then select **Phone Numbers**.
6. Select **Add**, on the Order name page type **Virginia Conference Bridge** for the order name and **Toll Number** for the friendly description. 
7. Under the Location and quantity section, select Country/Region: **United States**, and then select **Dedicated conference bridge (Toll)** for the number type.
8. Click **Add a Location**, in Order name type **Virginia **, in the Country or region select **United States**, for the **Address** enter **12012 Sunset Hills Road, Reston, VA 20190** 

    >**Note:** The address should resolve automatically. If the address you type in doesn't resolve in the Master Street Address Guid (MSAG) then you will need to correct the address to match a suggested address. Only validated civic addresses can be used for a voice location.


9. Verify that **I acknowledge and agree that I have read this information and understand how emergency calling works in Microsoft Teams. Please provide this information to users with phone numbers in your organization** is selected and click **Save**.
10. In the location box type **Reston** and select **Virginia** from the list, in the Area code select **571**.
11. In the Quantity box type **1** and then click **Next**.

12. On the Get numbers page document the number displayed under **Reserved numbers**: ___________________
13. Click **Place order**.
14. On the Confirmation page click **Finish**.
15. In the **Microsoft Teams admin center**, expand **Meetings**, and then select **Conference bridges**.
16. In the **Conference bridges** window, select **Add** and then select **Toll number**.
17.  In the Add phone number dialog box select the Toll number that you documented and then click **Apply**.

    >**Note:** You may need to refresh the Internet Explorer browser window to see the new service number.

18. Locate and select the new number on the Conference bridges page. 
20. Select **Set as Default** and then click **Edit**.
21. In the properties pane for the number, review the default language and alternate language options available for the conference bridge number. Change the second alternate language from **none** to **French (Canada)**, and then select **Apply**.
22. In the left navigation pane, select **Meeting settings**, and then review the available settings for **Participants**, **Email invitation**, and **Network**.
23. Scroll down to **Select a port range for each type of real-time media traffic**, and then note the port range that is displayed.
24. Close Internet Explorer.

#### Task 2: Prepare for the next module

- When you are finished with the lab, keep all virtual machines running. The next lab/modules require the virtual machines in their current state.

> **Result**: After completing this exercise, you will have successfully added a new service number for audio conferencing.


### Review question(s)

**Question** 

When moving users from Skype for Business Server 2019 to Skype for Business Online or Teams, what should you do to prevent move errors?

**Question** 

Which coexistence mode will allow users to run both Skype for Business Clients and Teams?


©2019 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode "Creative Commons Attribution 3.0 License"), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.



